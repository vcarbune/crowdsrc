{% extends "base_user.html" %} 

{% block head %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/toolbox.css">
<link rel="stylesheet" href="{{ STATIC_URL }}css/ui-lightness/jquery-ui-1.10.2.custom.min.css">

<script src="{{ STATIC_URL }}js/lib/jquery-ui-1.10.2.custom.min.js"></script>

<script src="http://code.angularjs.org/1.1.4/angular.js"></script>
<script src="http://code.angularjs.org/1.1.4/angular-sanitize.js"></script>
<script src="https://raw.github.com/angular-ui/angular-ui/master/build/angular-ui.min.js"></script>

<script type="text/javascript">
  var app = angular.module('angularjs-toolbox', ['ui']);
</script>
<script src="{{ STATIC_URL }}js/edit-task.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/toolbox.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/toolbox-items.js" type="text/javascript"></script>

{% endblock %}

{% block title %}
  Create new task
{% endblock %}
{% block content %}

<h2>Create Task</h2>

<form ng-app="angularjs-toolbox" method="post" 
	action="{% if task_form.instance.id %} {% url 'crowdapp.views.edit_task' task_form.instance.id %} {% else %} {% url 'crowdapp.views.edit_task' %} {% endif %} " 
	id="create-task-form" class="create-task-form" enctype="multipart/form-data">
	
	{% csrf_token %}
	
	{% if task_form.instance.id %}
		<input type="hidden" name="task-id" value="{{ task_form.instance.id }}" />
	{% endif %}
	
	{{ task_form.non_field_errors }}
	
	{{ task_form.name.label_tag }}: {{ task_form.name }} {{ task_form.name.errors }}
	<br><br>
	
	{% if not task_form.instance.accesspath_set.all %}
		<button type="button" id="add-accesspaths">Add access paths</button>
		<script type="text/javascript">
			$('#add-accesspaths').click(function(){
				$('#accesspaths').show();
				$('#add-accesspaths').hide();
			});
		</script>
	{% endif %}
	<div id="accesspaths" {% if not task_form.instance.accesspath_set.all %}style="display:none;"{% endif %}>
		Access Paths:
		<div id="accesspath-formset">
			{{ accesspath_formset.management_form }}
			{{ accesspath_formset.non_field_errors }}
	    	{% for accesspath_form in accesspath_formset.forms %}
	    		<div class="subform">
	    			{{ accesspath_form.as_p }}
	    		</div>
		    {% endfor %}
	    	
	    	<script type="text/javascript">
	    		$("#accesspath-formset label:contains('Delete')").hide(); <!-- TODO: find a better solution -->
	    		
		    	$(function() {
		    		$(".subform").formset({
		    			prefix: '{{ accesspath_formset.prefix }}',
		    			deleteText: "Remove item",
		    			addText: "Add",
		    		});
		    	});
	    	</script>
		</div>
	</div>
	<br>

	<!-- Begin Toolbox -->
	<div ng-controller="ToolboxCtrl" 
		{% if task_form.html.value %}
			ng-init="init({{ task_form.html.value }})"
		{% endif %} 
		class="toolbox">
	    <ul ui-sortable="sortableOptions" ng-model="content" class="toolbox-item-list">
	    	<li ng-repeat="item in content" class="toolbox-item">
	    		<toolbox-item content="item" itemcontent="item.itemContent"></toolbox-item>
	    		<button type="button" ng-click="removeElement(item.id)" ng-show="isEditable()">Remove</button>
	    	</li>
	    </ul>
	    
	    <div class="toolbox-new-elem">
	    	Add new element: 
	    	<select ng-model="newElemType" ng-options="i.code as i.name for i in elemTypes"></select> 
	    	<button type="button" ng-click="addElement()">Add</button>
	    </div>
  	</div>
  	<!-- End Toolbox -->

	<br>
	{{ task_form.cost.label_tag }}: {{ task_form.cost }} {{ task_form.cost.errors }}
	<br>
	{{ task_form.is_active }} {{ task_form.is_active.label_tag}}
	
	{{ task_form.html }}
	{{ task_form.resource_files }}
	<br>
  <div ng-controller="MasterFormCtrl">
	  <button ng-click="submitForm()" type="button">Save</button>
  </div>
</form>

{% endblock %}
