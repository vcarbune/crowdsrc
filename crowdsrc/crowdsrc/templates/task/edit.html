{% extends "base_user.html" %} 

{% block head %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/toolbox.css">
<link rel="stylesheet" href="{{ STATIC_URL }}css/ui-lightness/jquery-ui-1.10.2.custom.min.css">

<script src="{{ STATIC_URL }}js/lib/jquery-ui-1.10.2.custom.min.js"></script>

<script src="http://code.angularjs.org/1.1.4/angular.js"></script>
<script src="http://code.angularjs.org/1.1.4/angular-sanitize.js"></script>
<script src="https://raw.github.com/angular-ui/angular-ui/master/build/angular-ui.min.js"></script>

<script type="text/javascript">
  var app = angular.module('angularjs-toolbox', ['ui']);
</script>
<script src="{{ STATIC_URL }}js/edit-task.js" type="text/javascript"></script>

<script src="{{ STATIC_URL }}js/toolbox.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/toolbox-services.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/toolbox-items.js" type="text/javascript"></script>

{% endblock %}

{% block title %}
	{% if task_form.instance.id %} Edit task {% else %} Create task {% endif %}
{% endblock %}

<!-- JavaScript used only on this page -->
{% block pagescript %}
<script type="text/javascript">
  // Instead of hooking up in Django form generation, we're changing some
  // elements after the page load (less hassle and faster for minor changes).
  function onBodyLoad() {
    document.getElementById('id_task-name').placeholder =
        'Descriptive title of your task';
  }
</script>
{% endblock %}

{% block content %}

<h2>{% if task_form.instance.id %} Edit task {% else %} Create task {% endif %}</h2>

<form ng-app="angularjs-toolbox" method="post" 
	action="{% if task_form.instance.id %} {% url 'crowdapp.views.edit_task' task_form.instance.id %} {% else %} {% url 'crowdapp.views.edit_task' %} {% endif %} " 
	id="create-task-form" class="create-task-form" enctype="multipart/form-data">
	
	{% csrf_token %}
	
	{% if task_form.instance.id %}
		<input type="hidden" name="task-id" value="{{ task_form.instance.id }}" />
	{% endif %}
	
	{{ task_form.non_field_errors }}
	
	{{ task_form.name.label_tag }}: {{ task_form.name }} {{ task_form.name.errors }}

	{% if accesspath_formset.initial_form_count == 0 %}
		<button type="button" id="add-accesspaths">Insert access paths</button>
    <!-- FIXME: This needs to be moved in the block pagescript. -->
		<script type="text/javascript">
			$('#add-accesspaths').click(function(){
				$('#accesspaths').show();
				$('#add-accesspaths').hide();
			});
		</script>
	{% endif %}
	<div id="accesspaths" {% if accesspath_formset.initial_form_count == 0 %} style="display:none;"{% endif %}>
		Access Paths:
		<div id="accesspath-formset">
			{{ accesspath_formset.management_form }}
			{{ accesspath_formset.non_field_errors }}
	    	{% for accesspath_form in accesspath_formset.forms %}
	    		<div class="subform">
	    			{{ accesspath_form.as_p }}
	    		</div>
		    {% endfor %}
        
        <!-- FIXME: This needs to be moved in the block pagescript. -->	
	    	<script type="text/javascript">
	    		$("#accesspath-formset label:contains('Delete')").hide(); <!-- TODO: find a better solution -->
	    		
		    	$(function() {
		    		$(".subform").formset({
		    			prefix: '{{ accesspath_formset.prefix }}',
		    			deleteText: "Remove item",
		    			addText: "Add",
		    		});
		    	});
	    	</script>
		</div>
	</div>
	<br>

	<!-- Begin Toolbox -->
	<div ng-controller="ToolboxCtrl" 
		{% if task_form.content.value %}
		ng-init="init({{ task_form.content.value }}, 'EDIT')"
		{% endif %} 
		class="toolbox-container">
      <div class="toolbox-icons-list">
        {% verbatim %}
        <span class="toolbox-icon" ng-repeat="type in elemTypes" ng-click="addElement('{{type.code}}')">
          <img src="/static/img/toolbox-icons/{{type.icon}}" title="{{type.name}}">
        </span>
        {% endverbatim %}
      </div>

	    <ul ui-sortable="sortableOptions" ng-model="content" class="toolbox-item-list">
        {% verbatim %}
    	  <li ng-repeat="item in content" class="toolbox-item" id="{{item.id}}">
	    		<toolbox-item content="item" itemcontent="item.itemContent"></toolbox-item>
	    		<button type="button" ng-click="removeElement(item.id)" ng-show="isEditable()">Remove</button>
	    	</li>
        {% endverbatim %}
	    </ul>
  	</div>
  	<!-- End Toolbox -->

  {{ task_form.qualifications.label}}: {{ task_form.qualifications }}
	<br>
	{{ task_form.cost.label_tag }}: {{ task_form.cost }} {{ task_form.cost.errors }}
	<br>
	{{ task_form.is_active }} {{ task_form.is_active.label_tag}}
	
	{{ task_form.content }}
	{{ task_form.resource_files }}
	<br>
  <div ng-controller="MasterFormCtrl">
	  <button ng-click="submitForm()" type="button">Save</button>
  </div>
</form>

{% endblock %}
